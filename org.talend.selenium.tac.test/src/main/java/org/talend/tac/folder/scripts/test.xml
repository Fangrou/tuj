<project name="testng" default="run-tests" basedir=".">
	<propertyset id="tests.properties">
		<propertyref name="selenium.target.src"/>
	    <propertyref name="tests.on.hudson"/>
		<propertyref name="tomcat.url"/>
		<propertyref name="selenium.server"/>
		<propertyref name="selenium.browser"/>
	</propertyset>

	
	<!-- testng path -->
	<taskdef name="svn" classname="org.tigris.subversion.svnant.SvnTask" />

	<taskdef name="testng" classname="org.testng.TestNGAntTask">
		<classpath>
			<pathelement location="${hudson.selenium.libs}/testng-6.0.1.jar" />
		</classpath>
	</taskdef>

	<path id="libs.classpath">
		<!-- <pathelement location="./libs/junit.jar"/> -->
		<fileset dir="${hudson.selenium.libs}" id="libs.path.id">
		    <include name="*.jar"/>
		</fileset>
	</path>

	<path id="src.classpath">
		<pathelement location="${selenium.project}/src/main/java" />
		<pathelement location="${selenium.project}/src/main/resources" />
	</path>	

	<path id="target.classpath">
		<pathelement location="${selenium.target}" />
	</path>

	<path id="test.classpath">
		<path refid="libs.classpath" />
		<path refid="target.classpath" />
	</path>
	
	<target name="init-test" description="Preparation">
		<mkdir dir="${report_dir}"/>
		<mkdir dir="${selenium.project}"/>
		<mkdir dir="${selenium.target}"/>
	</target>

	<target name="destory-test" description="Destory">
		<delete dir="${selenium.target}"/>
		<delete dir="${selenium.project}"/>
	</target>
	

	<!-- - - - - - - - - - - - - - - - - - 
          target: copy-file              
         - - - - - - - - - - - - - - - - - -->
    <target name="update-datas">
    	<rename src="${tac.home}/org.talend.administrator.war" dest="${tac.home}/org.talend.administrator.old.war"/>
    	<unjar src="${tac.home}/org.talend.administrator.old.war" dest="${tac.home}/org.talend.administrator"/>
    	
    	
    	<!-- set license, need check if test the tests of license or not -->
    	<if>
    		<!--
    		<isset property="test.on.database"/>
    		-->
    		<equals arg1="${test.on.database}" arg2="true" />
    		<then>
    			<echo>Don't test license!</echo>
    	    	<loadfile srcfile="${selenium.project}/${selenium.file.folder}/license" property="license">	
    	    		<filterchain>
    	    			<headfilter lines="1"/>			
    	    		</filterchain>
    	    	</loadfile>	
    	    	<echo></echo>
    	    	<echo append="false" file="${tac.home}/org.talend.administrator/WEB-INF/classes/install.txt">license.key=${license}</echo>
    			
    			<copyfile dest="${tac.home}/org.talend.administrator/WEB-INF/classes/configuration.properties" src="configuration.properties"/>
    		</then>
    		<else>
    			<echo>Test license!</echo>
    		</else>
    	</if>
    	

    	
    	<jar destfile="${tac.home}/org.talend.administrator.war">
    		<fileset dir="${tac.home}/org.talend.administrator" excludes="WEB-INF/database/**/*"/>
    	</jar>
    	<echo>Remove old dirty datas from war file!</echo>
    	<delete file="${tac.home}/org.talend.administrator.old.war"/>
    		
		<!-- Copy license to Talend-All -->
		<copy todir="${talend-all.home}">
			<fileset dir="${selenium.project}/${selenium.file.folder}">
				<include name="license" />
			</fileset>
		</copy>
    </target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          update tests and copy license to Talend-all                    
         - - - - - - - - - - - - - - - - - -->
	<target name="update" description="update">
		
		<delete dir="${selenium.target}"/>
		<mkdir dir="${selenium.target}"/>
		
		<echo>Update -- ${svn.url}</echo>
		<svn username="${svn.user}" password="${svn.password}">
			<update revision="HEAD"  dir="${selenium.project}"/>
		</svn>
		
		<!-- Copy license to Talend-All -->
		<antcall target="update-datas"/>
	</target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          checkout tests and copy license to Talend-all                    
         - - - - - - - - - - - - - - - - - -->
	<target name="checkout" description="checkout">
		
		<antcall target="destory-test"/>
		<antcall target="init-test"/>
		
		<echo>Checkout -- ${svn.url}</echo>
		<svn username="${svn.user}" password="${svn.password}">
			<checkout url="${svn.url}" revision="HEAD" destPath="${selenium.project}"/>
		</svn>
		
		<!-- Copy license to Talend-All -->
		<copy todir="${talend-all.home}">
			<fileset dir="${selenium.project}/${selenium.file.folder}">
				<include name="license" />
			</fileset>
		</copy>
	</target>

	
	<target name="compile-test" description="Compilation of the test classes">
		<echo>compile tests ----</echo>
		<!-- Compilation of the Selenium tests -->
		<javac srcdir="${selenium.project}/src" debug="true" debuglevel="lines,vars,source" 
				destdir="${selenium.target}" includeantruntime="false">
			<classpath refid="libs.classpath" />
			<classpath refid="src.classpath" />
		</javac>
		<echo>44444</echo>
		<copy todir="${selenium.target}">
			<fileset dir="${selenium.project}/src/main/resources">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${selenium.target}/${selenium.file.folder}">
			<fileset dir="${selenium.project}/${selenium.file.folder}">
				<include name="*" />
			</fileset>
		</copy>
		<copy todir="${selenium.target}/src/main/java/org/talend/tac/folder">
			<fileset dir="${selenium.project}/src/main/java/org/talend/tac/folder">
				<include name="**/*" />
			</fileset>
		</copy>

		<copy todir="${selenium.target}/src/main/java">
			<fileset dir="${selenium.project}/src/main/java" casesensitive="yes">
				<include name="**/*.xml" />
			</fileset>
		</copy>

		<echo>Compilation of the test classes</echo>
	</target>


	<target name="compile-tests" description="Compilation of the test classes">
		<echo>${hudson.selenium.libs}</echo>
		<echo>compile tests ----</echo>
		<!-- Compilation of the Selenium tests -->
		<javac srcdir="${selenium.project}/src" debug="true" debuglevel="lines,vars,source" 
				destdir="${selenium.target}" includeantruntime="false">
			<classpath refid="libs.classpath" />
			<classpath refid="src.classpath" />
		</javac>
		<echo>44444</echo>
		<copy todir="${selenium.target}">
			<fileset dir="${selenium.project}/src/main/resources">
				<include name="**/*" />
			</fileset>
		</copy>
		<copy todir="${selenium.target}/${selenium.file.folder}">
			<fileset dir="${selenium.project}/${selenium.file.folder}">
				<include name="*" />
			</fileset>
		</copy>

		<copy todir="${selenium.target}/src/main/java">
			<fileset dir="${selenium.project}/src/main/java" casesensitive="yes">
				<include name="**/*.xml" />
			</fileset>
		</copy>

		<echo>Compilation of the test classes</echo>
	</target>
	
	<!-- Run the TestNG tests depends="compile-test"  -->
	<target name="testng-test" description="Run the TestNG tests">
		<!-- <testng outputdir="${report_dir}" classpathref="test.classpath"> -->
		<testng outputdir="${report_dir}" classpathref="test.classpath">
			<xmlfileset dir="${selenium.target}/src/main/java" includes="${xmlfile}.xml" />
			<propertyset refid="tests.properties"/>
		</testng>
		<echo>Run the TestNG tests</echo>
	</target>
	
	<!-- - - - - - - - - - - - - - - - - - 
          target: run                      
         - - - - - - - - - - - - - - - - - -->
    <target name="run-tests">
        <echo>--build.version----- ${build.version}</echo>
    	<echo>--- tac.home --- ${tac.home}</echo>
    	
		<antcall target="testng-test"/>
    </target>

</project>
